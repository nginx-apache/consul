# 5.Services

## 1.Services

服务发现的主要目标之一是提供可用服务的目录。为此，代理提供了一种简单的服务定义格式，用于声明服务的可用性，并可能将其与运行状况检查关联。
如果健康检查与服务相关联，则认为它是应用程序级别。服务在配置文件中定义，或在运行时通过HTTP接口添加。

## 2.Service Definition

要配置服务，请将服务定义作为`-config-file`选项提供给代理，或者将其放在代理的`-config-dir`中。文件必须以要由Consul加载的.json或.hcl扩展名结尾。
可以通过向代理发送叹息来更新检查定义。或者，可以使用HTTP API动态注册服务。

服务定义是如下所示的配置。此示例显示所有可能的字段，但请注意，只需要少数字段。
```json
{
  "service": {
    "id": "redis",
    "name": "redis",
    "tags": ["primary"],
    "address": "",
    "meta": {
      "meta": "for my service"
    },
    "port": 8000,
    "enable_tag_override": false,
    "checks": [
      {
        "args": ["/usr/local/bin/check_redis.py"],
        "interval": "10s"
      }
    ],
    "kind": "connect-proxy",
    "proxy_destination": "redis", // Deprecated
    "proxy": {
      "destination_service_name": "redis",
      "destination_service_id": "redis1",
      "local_service_address": "127.0.0.1",
      "local_service_port": 9090,
      "config": {},
      "upstreams": []
    },
    "connect": {
      "native": false,
      "sidecar_service": {},
      "proxy": {  // Deprecated
        "command": [],
        "config": {}
      }
    },
    "weights": {
      "passing": 5,
      "warning": 1
    },
    "token": "233b604b-b92e-48c8-a253-5f11514e4b50"
  }
}
```

服务定义必须包含`name`，并且可以选择提供`id`, `tags`, `address`,` meta`, `port`, `enable_tag_override`和 `check`。如果未提供`id`，则将其设置为`name`。
要求所有服务都具有每个节点的唯一ID，因此如果名称可能冲突，则应提供唯一ID。

`tags`属性是一个对Consul不透明的值列表，但可用于区分主节点或辅助节点、不同版本或任何其他服务级别标签。

`address`字段可用于指定特定于服务的IP地址。默认情况下，使用代理的IP地址，不需要提供该地址。端口字段还可以用来简化面向服务的体系结构的配置；这样，就可以发现服务的地址和端口。

`meta`对象是一个包含字符串语义的最大64个键/值的映射。键只能包含ASCII字符，不能包含特殊字符（a-z a-z 0-9_u和-）。出于性能和安全原因，值和键对于键的限制为128个字符，对于值的限制为512个字符。
此对象与节点定义中的节点元对象具有相同的限制。所有这些元数据都可以在服务的每个实例中单独检索，并且给定服务的所有实例都有自己的副本。

服务还可以包含一个`token`字段来提供ACL`token`。此令牌用于与服务目录的任何交互，包括`anti-entropy`同步和取消注册。

可以选择指定启用`enable_tag_override`来禁用此服务的`anti-entropy`功能。如果`enable_tag_override`设置为`true`，则外部代理可以在目录中更新此服务并修改`tag`。此代理的后续本地同步操作将忽略更新的`tag`。
例如，如果外部代理修改了此服务的标记和端口，并将`enable_tag_override`设置为`true`，则在下一个同步周期之后，服务的端口将恢复为原始值，但标记将保持更新的值。
例如：如果外部代理修改了此服务的标记和端口并将`enable_tag_override`设置为`false`，那么在下一个同步周期之后，服务的端口和标记将恢复为原始值，所有修改都将丢失。

需要注意的是，这只适用于本地注册的服务。如果有多个节点都在注册同一个服务，那么它们的启用`enable_tag_override`配置和所有其他服务配置项彼此独立。
更新在一个节点上注册的服务的标记独立于在另一个节点上注册的相同服务（按名称）。如果未指定启用`enable_tag_override`，则默认值为false。
更多信息请参见`anti-entropy`同步。

对于Consul 0.9.3及更早版本，您需要使用EnableTagOverride。Consul 1.0既支持启用标记覆盖，也支持启用标记覆盖，但后者已被弃用，并已从Consul 1.1中删除。

## 3.Connect
`kind`字段用于选择性地将服务标识为具有值`connect-proxy`的连接代理实例。对于典型的非代理实例，必须省略kind字段。“代理”字段对于“连接代理”注册也是必需的，并且仅当“种类”为“连接代理”时才有效。
唯一需要的代理字段是目标\服务\名称。有关详细信息，请参阅完整的代理配置示例。