# 6.Checks

代理的主要角色之一是管理系统级和应用程序级的运行状况检查。如果健康检查与服务相关联，则认为它是应用程序级别。如果未与服务关联，则检查将监视整个节点的运行状况。

检查在配置文件中定义，或在运行时通过HTTP接口添加。通过HTTP接口创建的检查将与该节点保持一致。

有几种不同类型的`check`：

* `Script` + `Interval`-这些检查依赖于调用执行运行状况检查的外部应用程序，使用适当的退出代码退出，并可能生成一些输出。脚本与调用间隔（例如，每30秒）配对。这类似于`Nagios`插件系统。
脚本检查的输出限制为4KB。大于此值的输出将被截断。默认情况下，脚本检查将配置为超时等于30秒。可以通过在检查定义中指定超时字段来配置自定义脚本检查超时值。
当Windows超时时，Consul将等待脚本生成的任何子进程完成。对于任何其他系统，Consul都将尝试强制终止脚本和在超时结束后生成的任何子进程。
在Consul 0.9.0和更高版本中，默认情况下不启用脚本检查。要使用它们，您可以使用：

* `enable_local_script_checks`: 启用在本地配置文件中定义的脚本检查。不允许通过HTTP API定义的脚本检查。
* `enable_script_checks`: 启用脚本检查，不管它们是如何定义的。

```text
安全警告：在某些配置中启用脚本检查可能会导致远程执行漏洞，已知该漏洞是恶意软件的目标。我们强烈建议启用本地脚本检查。有关详细信息，请参阅此日志。
```

* `HTTP + Interval` 这些检查每隔一段时间（例如每30秒）向指定的URL发出一个HTTP GET请求。
服务的状态取决于HTTP响应代码：任何2xx代码都被认为是通过的，太多的429请求都是一个警告，而其他任何请求都是失败的。
与使用curl或其他外部进程检查简单HTTP操作的脚本相比，应首选这种检查类型。默认情况下，HTTP检查是GET请求，除非`method`字段指定了不同的方法。
其他标题字段可以通过标题字段设置，标题字段是字符串列表的映射，例如{"x-foo": ["bar", "baz"]}。默认情况下，HTTP检查将配置为请求超时等于检查间隔，最长为10秒。
可以通过在检查定义中指定超时字段来配置自定义HTTP检查超时值。检查的输出限制在大约4KB。大于此值的响应将被截断。HTTP检查也支持TLS。默认情况下，需要有效的TLS证书。
通过在检查定义中将tls_skip_verify字段设置为true，可以关闭证书验证

* `TCP + Interval` 这些检查会每隔一段时间（例如每30秒）对指定的IP/主机名和端口进行一次TCP连接尝试。如果未指定主机名，则默认为“localhost”。
服务的状态取决于连接尝试是否成功（即端口当前正在接受连接）。如果接受连接，则状态为`success`，否则状态为`critical`。如果主机名同时解析为IPv4和IPv6地址，将尝试对这两个地址执行操作，并且第一次成功连接尝试将导致成功检查。
这种类型的检查应该优先于使用netcat或其他外部进程检查简单套接字操作的脚本。默认情况下，TCP检查将配置为请求超时等于检查间隔，最长为10秒。可以通过在检查定义中指定`timeout`字段来配置自定义TCP检查超时值。